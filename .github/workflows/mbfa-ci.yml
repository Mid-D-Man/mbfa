name: MBFA Build & Benchmark

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  parse-commit:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: Check for publish flag
        id: check
        run: |
          SHOULD_PUBLISH="false"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SHOULD_PUBLISH="true"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            if echo "$COMMIT_MSG" | grep -qiE '\-\-(publish|deploy)'; then
              SHOULD_PUBLISH="true"
            fi
          fi
          echo "should_publish=${SHOULD_PUBLISH}" >> $GITHUB_OUTPUT
          echo "Will publish results: ${SHOULD_PUBLISH}"

  build-and-test:
    runs-on: ${{ matrix.os }}
    needs: parse-commit
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check Formatting
        run: cargo fmt -- --check || true

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings 2>&1 | tee clippy-${{ matrix.os }}.txt || true

      - name: Build Debug
        run: cargo build --verbose 2>&1 | tee build-debug-${{ matrix.os }}.txt

      - name: Build Release
        run: cargo build --release --verbose 2>&1 | tee build-release-${{ matrix.os }}.txt

      - name: Run Tests
        run: cargo test --verbose 2>&1 | tee test-${{ matrix.os }}.txt

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.os }}-${{ github.run_number }}
          path: "*.txt"
          retention-days: 30

  # ‚îÄ‚îÄ Update project structure ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  update-structure:
    runs-on: ubuntu-latest
    needs: [parse-commit, build-and-test]
    if: needs.parse-commit.outputs.should_publish == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update ProjectStructure.txt
        run: |
          mkdir -p others
          {
            echo "Project Structure ‚Äî MidMans Bit Folding Algorithm (MBFA)"
            echo "MidManStudio"
            echo "Generated: $(date -u)"
            echo "Repository: ${{ github.repository }}"
            echo "Commit: ${{ github.sha }}"
            echo "Branch: ${{ github.ref_name }}"
            echo "Build: #${{ github.run_number }}"
            echo "=================================="
            echo
            echo "Source Files:"
            find src -type f -name "*.rs" | sort
            echo
            echo "Bench Files:"
            find benches -type f -name "*.rs" 2>/dev/null | sort || echo "None"
            echo
            echo "Config:"
            ls -1 *.toml *.md 2>/dev/null | sort
            echo
            echo "Counts:"
            echo "  src: $(find src -type f -name '*.rs' | wc -l) files"
            echo "  benches: $(find benches -type f -name '*.rs' 2>/dev/null | wc -l || echo 0) files"
          } > others/ProjectStructure.txt

          cat others/ProjectStructure.txt

      - name: Commit structure update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "MBFA CI"
          git add others/ProjectStructure.txt
          git diff --staged --quiet || git commit -m "Auto-update project structure ‚Äî Build #${{ github.run_number }} [skip ci]"
          git push || true

  # ‚îÄ‚îÄ Benchmark ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  benchmark:
    runs-on: ubuntu-latest
    needs: [parse-commit, build-and-test]
    if: needs.parse-commit.outputs.should_publish == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ubuntu-latest-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install tools
        run: sudo apt-get install -y gzip zstd bc

      - name: Build Release
        run: cargo build --release

      - name: Prepare benchmark files
        run: |
          mkdir -p bench_files bench_results
          python3 -c "print('the the the and the and ' * 500)" > bench_files/repetitive.txt
          python3 -c "import os; open('bench_files/random.bin','wb').write(os.urandom(10000))"
          cp src/encoder.rs bench_files/source_code.rs
          curl -s -o bench_files/alice.txt "https://www.gutenberg.org/files/11/11-0.txt" || \
            python3 -c "print('the quick brown fox ' * 5000)" > bench_files/alice.txt
          head -c 20000 bench_files/alice.txt > bench_files/alice_small.txt
          head -c 100000 bench_files/alice.txt > bench_files/alice_100k.txt

      - name: Roundtrip verification
        run: |
          echo "the the the and the and the cat sat on the mat" > bench_files/roundtrip_test.txt
          ./target/release/mbfa compress bench_files/roundtrip_test.txt bench_files/roundtrip_test.mbfa
          ./target/release/mbfa decompress bench_files/roundtrip_test.mbfa bench_files/roundtrip_recovered.txt
          if diff bench_files/roundtrip_test.txt bench_files/roundtrip_recovered.txt > /dev/null 2>&1; then
            echo "ROUNDTRIP: PASSED"
          else
            echo "ROUNDTRIP: FAILED"
            exit 1
          fi

      - name: Run benchmarks
        run: |
          # Helper: ensure bc output always has a leading zero before decimal point
          fix_pct() { echo "$1" | sed 's/^\./0./'; }

          # Start JSON array
          echo "[" > bench_results/results.json
          FIRST=true

          run_bench() {
            local file=$1
            local name=$2
            local orig_size=$(wc -c < "bench_files/$file")

            # MBFA compress ‚Äî capture stdout (fold detail) to log
            local mbfa_start=$(date +%s%N)
            ./target/release/mbfa compress "bench_files/$file" "bench_files/$file.mbfa" \
              > bench_results/mbfa_log_${name}.txt 2>&1
            local mbfa_end=$(date +%s%N)
            local mbfa_ms=$(( (mbfa_end - mbfa_start) / 1000000 ))
            local mbfa_size=$(wc -c < "bench_files/$file.mbfa" 2>/dev/null || echo 0)

            # Fold detail ‚Äî escape quotes and newlines for JSON
            local fold_detail=$(cat bench_results/mbfa_log_${name}.txt | \
              grep -E "^(Original|Fold|Done)" | \
              tr '\n' '|' | \
              sed 's/"/\\"/g')

            # MBFA decompress + verify roundtrip
            ./target/release/mbfa decompress "bench_files/$file.mbfa" "bench_files/$file.recovered" \
              > /dev/null 2>&1
            local roundtrip="PASS"
            if ! diff "bench_files/$file" "bench_files/$file.recovered" > /dev/null 2>&1; then
              roundtrip="FAIL"
            fi

            # gzip
            local gz_start=$(date +%s%N)
            gzip -k -f "bench_files/$file" 2>/dev/null
            local gz_end=$(date +%s%N)
            local gz_ms=$(( (gz_end - gz_start) / 1000000 ))
            local gz_size=$(wc -c < "bench_files/$file.gz" 2>/dev/null || echo 0)

            # zstd
            local zst_start=$(date +%s%N)
            zstd -q -f "bench_files/$file" -o "bench_files/$file.zst" 2>/dev/null
            local zst_end=$(date +%s%N)
            local zst_ms=$(( (zst_end - zst_start) / 1000000 ))
            local zst_size=$(wc -c < "bench_files/$file.zst" 2>/dev/null || echo 0)

            local mbfa_pct=$(fix_pct $(echo "scale=2; $mbfa_size * 100 / $orig_size" | bc))
            local gz_pct=$(fix_pct $(echo "scale=2; $gz_size * 100 / $orig_size" | bc))
            local zst_pct=$(fix_pct $(echo "scale=2; $zst_size * 100 / $orig_size" | bc))

            # Comma between entries but not before first
            if [ "$FIRST" = "true" ]; then
              FIRST=false
            else
              echo "," >> bench_results/results.json
            fi

            cat >> bench_results/results.json << EOJSON
          {
            "dataset": "$name",
            "original_bytes": $orig_size,
            "mbfa_bytes": $mbfa_size,
            "mbfa_pct": $mbfa_pct,
            "mbfa_ms": $mbfa_ms,
            "mbfa_roundtrip": "$roundtrip",
            "gzip_bytes": $gz_size,
            "gzip_pct": $gz_pct,
            "gzip_ms": $gz_ms,
            "zstd_bytes": $zst_size,
            "zstd_pct": $zst_pct,
            "zstd_ms": $zst_ms,
            "fold_detail": "$fold_detail"
          }
          EOJSON

            printf "%-22s %9s B | MBFA: %6s%% (%sms) | gzip: %6s%% (%sms) | zstd: %6s%% (%sms) | rt: %s\n" \
              "$name" "$orig_size" "$mbfa_pct" "$mbfa_ms" "$gz_pct" "$gz_ms" "$zst_pct" "$zst_ms" "$roundtrip"
          }

          echo "================================================================"
          echo "  MidMans Bit Folding Algorithm ‚Äî Benchmark Results"
          echo "  Build #${{ github.run_number }} | $(date -u)"
          echo "================================================================"

          run_bench "repetitive.txt"  "Repetitive_12KB"
          run_bench "alice_small.txt" "Prose_Alice_20KB"
          run_bench "alice_100k.txt"  "Prose_Alice_100KB"
          run_bench "random.bin"      "Random_10KB"
          run_bench "source_code.rs"  "Source_Code_3KB"

          # Close JSON array
          echo "]" >> bench_results/results.json

          echo "================================================================"
          echo "Lower % = better"

          echo "--- results.json preview ---"
          cat bench_results/results.json

      - name: Generate HTML report
        run: |
          BUILD_DATE=$(date -u)
          BUILD_NUM="${{ github.run_number }}"
          COMMIT="${{ github.sha }}"
          BRANCH="${{ github.ref_name }}"

          cat > bench_results/index.html << 'EOHTML'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>MBFA Benchmark Results</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0d1117; color: #e6edf3; padding: 32px 24px; }
              .container { max-width: 1100px; margin: 0 auto; }
              header { border-bottom: 2px solid #f78166; padding-bottom: 20px; margin-bottom: 32px; }
              header h1 { font-size: 2rem; color: #f78166; }
              header h1 span { color: #e6edf3; }
              .meta { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 12px; }
              .meta-item { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 6px 14px; font-size: 0.85rem; }
              .meta-item strong { color: #79c0ff; }
              .banner { background: #0f2a1a; border: 1px solid #2ea043; border-radius: 8px; padding: 14px 20px; margin-bottom: 28px; color: #3fb950; font-weight: 600; }
              .banner.fail { background: #2a0f0f; border-color: #f85149; color: #f85149; }
              .toolbar { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
              .copy-btn { background: #21262d; border: 1px solid #30363d; color: #e6edf3; padding: 7px 16px; border-radius: 6px; font-size: 0.82rem; cursor: pointer; display: flex; align-items: center; gap: 7px; transition: background 0.15s, border-color 0.15s; }
              .copy-btn:hover { background: #2d333b; border-color: #8b949e; }
              .copy-btn.copied { background: #0f2a1a; border-color: #2ea043; color: #3fb950; }
              .copy-btn svg { flex-shrink: 0; }
              table { width: 100%; border-collapse: collapse; background: #161b22; border: 1px solid #30363d; border-radius: 8px; overflow: hidden; margin-bottom: 32px; font-size: 0.88rem; }
              thead tr { background: #1c2128; }
              th { padding: 10px 14px; text-align: left; color: #8b949e; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #30363d; }
              td { padding: 10px 14px; border-bottom: 1px solid #21262d; vertical-align: top; }
              tr:last-child td { border-bottom: none; }
              tbody tr { cursor: pointer; }
              tbody tr:hover td { background: #1c2128; }
              .win  { color: #3fb950; font-weight: 700; }
              .loss { color: #f85149; }
              .tie  { color: #e3b341; }
              .pass { color: #3fb950; font-weight: 600; }
              .fail { color: #f85149; font-weight: 600; }
              .bar-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
              .bar { height: 8px; border-radius: 4px; min-width: 2px; }
              .bar-mbfa { background: #f78166; }
              .bar-gzip { background: #79c0ff; }
              .bar-zstd { background: #a371f7; }
              .fold-detail { font-family: monospace; font-size: 0.72rem; color: #8b949e; line-height: 1.6; white-space: pre-wrap; }
              .section-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 12px; border-left: 3px solid #f78166; padding-left: 10px; }
              footer { margin-top: 40px; padding-top: 16px; border-top: 1px solid #30363d; color: #8b949e; font-size: 0.78rem; text-align: center; }
              .legend { display: flex; gap: 18px; margin-bottom: 10px; font-size: 0.8rem; }
              .legend-item { display: flex; align-items: center; gap: 5px; }
              .dot { width: 9px; height: 9px; border-radius: 50%; display: inline-block; }
              .notes { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 18px; font-size: 0.85rem; line-height: 1.8; color: #8b949e; }
              .click-hint { font-size: 0.72rem; color: #484f58; margin-top: 4px; }

              /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
              .modal-overlay {
                display: none; position: fixed; inset: 0;
                background: rgba(0,0,0,0.72); z-index: 1000;
                align-items: center; justify-content: center; padding: 20px;
              }
              .modal-overlay.open { display: flex; }
              .modal {
                background: #161b22; border: 1px solid #30363d; border-radius: 12px;
                width: 100%; max-width: 680px; max-height: 90vh;
                display: flex; flex-direction: column; overflow: hidden;
                box-shadow: 0 24px 64px rgba(0,0,0,0.6);
                animation: modal-in 0.18s ease;
              }
              @keyframes modal-in { from { transform: translateY(18px); opacity: 0; } to { transform: none; opacity: 1; } }
              .modal-header {
                display: flex; align-items: center; justify-content: space-between;
                padding: 18px 22px; border-bottom: 1px solid #30363d; flex-shrink: 0;
              }
              .modal-title { font-size: 1.1rem; font-weight: 700; color: #f78166; }
              .modal-subtitle { font-size: 0.78rem; color: #8b949e; margin-top: 3px; }
              .modal-close {
                background: #21262d; border: 1px solid #30363d; color: #8b949e;
                width: 32px; height: 32px; border-radius: 6px; font-size: 1.1rem;
                cursor: pointer; display: flex; align-items: center; justify-content: center;
                transition: background 0.15s, color 0.15s; flex-shrink: 0;
              }
              .modal-close:hover { background: #2d333b; color: #e6edf3; }
              .modal-body { padding: 22px; overflow-y: auto; display: flex; flex-direction: column; gap: 22px; }

              .modal-section-label {
                font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.8px;
                color: #484f58; font-weight: 600; margin-bottom: 10px;
              }

              /* stat grid */
              .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
              .stat-card {
                background: #0d1117; border: 1px solid #21262d; border-radius: 8px;
                padding: 12px 14px;
              }
              .stat-card .stat-label { font-size: 0.72rem; color: #8b949e; margin-bottom: 4px; }
              .stat-card .stat-value { font-size: 1.05rem; font-weight: 700; }
              .stat-card .stat-sub { font-size: 0.72rem; color: #484f58; margin-top: 2px; }

              /* comparison bars */
              .cmp-row { display: flex; flex-direction: column; gap: 8px; }
              .cmp-item { display: grid; grid-template-columns: 56px 1fr 64px 68px; align-items: center; gap: 10px; }
              .cmp-label { font-size: 0.78rem; color: #8b949e; }
              .cmp-track { background: #0d1117; border-radius: 4px; height: 10px; overflow: hidden; }
              .cmp-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
              .cmp-pct { font-size: 0.82rem; font-weight: 700; text-align: right; }
              .cmp-bytes { font-size: 0.72rem; color: #484f58; text-align: right; }

              /* fold steps */
              .fold-steps { display: flex; flex-direction: column; gap: 0; }
              .fold-step {
                display: flex; gap: 14px; align-items: flex-start;
                padding: 10px 0; border-bottom: 1px solid #21262d; position: relative;
              }
              .fold-step:last-child { border-bottom: none; }
              .fold-step-icon {
                width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
                display: flex; align-items: center; justify-content: center;
                font-size: 0.72rem; font-weight: 700; margin-top: 1px;
              }
              .fold-step-icon.origin { background: #1c2128; border: 1px solid #30363d; color: #8b949e; }
              .fold-step-icon.fold   { background: #0f1e3a; border: 1px solid #1f4080; color: #79c0ff; }
              .fold-step-icon.stop   { background: #2a0f0f; border: 1px solid #5a1a1a; color: #f85149; }
              .fold-step-icon.done   { background: #0f2a1a; border: 1px solid #1a5a2a; color: #3fb950; }
              .fold-step-content { flex: 1; }
              .fold-step-title { font-size: 0.85rem; font-weight: 600; color: #e6edf3; }
              .fold-step-detail { font-size: 0.78rem; color: #8b949e; margin-top: 3px; }
              .fold-step-bar-wrap { margin-top: 6px; }
              .fold-step-bar-track { background: #0d1117; border-radius: 3px; height: 6px; overflow: hidden; }
              .fold-step-bar-fill { height: 100%; border-radius: 3px; background: #79c0ff; }
              .fold-step-ratio { font-size: 0.7rem; color: #484f58; margin-top: 3px; }
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <h1>ü¶Ä MBFA <span>‚Äî MidMans Bit Folding Algorithm</span></h1>
                <p style="color:#8b949e;margin-top:6px;">MidManStudio | Benchmark Results</p>
                <div class="meta">
                  <div class="meta-item"><strong>Build:</strong> <span id="m-build">#‚Äî</span></div>
                  <div class="meta-item"><strong>Branch:</strong> <span id="m-branch">‚Äî</span></div>
                  <div class="meta-item"><strong>Commit:</strong> <span id="m-commit">‚Äî</span></div>
                  <div class="meta-item"><strong>Date:</strong> <span id="m-date">‚Äî</span></div>
                </div>
              </header>

              <div class="banner" id="rt-banner">‚è≥ Checking roundtrip status...</div>

              <div class="toolbar">
                <div class="section-title" style="margin-bottom:0">Compression Results</div>
                <button class="copy-btn" id="copy-btn">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
                    <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
                  </svg>
                  Copy results.json
                </button>
              </div>

              <div class="legend">
                <div class="legend-item"><div class="dot" style="background:#f78166"></div>MBFA</div>
                <div class="legend-item"><div class="dot" style="background:#79c0ff"></div>gzip</div>
                <div class="legend-item"><div class="dot" style="background:#a371f7"></div>zstd</div>
              </div>
              <p class="click-hint" style="margin-bottom:10px">üí° Click any row for a detailed breakdown</p>

              <table>
                <thead>
                  <tr>
                    <th>Dataset</th>
                    <th>Original</th>
                    <th>MBFA</th>
                    <th>gzip</th>
                    <th>zstd</th>
                    <th>Roundtrip</th>
                    <th>Visual</th>
                    <th>Fold Detail</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>

              <div class="section-title">About MBFA ‚Äî Conceptual Status</div>
              <div class="notes">
                <p><strong style="color:#e6edf3">What MBFA is:</strong> MidMans Bit Folding Algorithm is a novel multi-fold iterative compression algorithm under active research and development by MidManStudio. The core concept ‚Äî encoding data as an instruction chain where each fold produces a bitstream that reconstructs the previous fold ‚Äî is architecturally distinct from existing published compression algorithms.</p>
                <br>
                <p><strong style="color:#e6edf3">Current implementation status:</strong> This is a research implementation. The algorithm is functionally correct (all roundtrips pass) but not yet optimised for competitive compression ratios on general data. Active work is ongoing on operand encoding (Exp-Golomb replacing Cantor pairing), Move-To-Front transforms between folds, and entropy coding strategies.</p>
                <br>
                <p><strong style="color:#e6edf3">Where MBFA currently wins:</strong> Highly repetitive data ‚Äî the multi-fold convergence dramatically outperforms gzip and zstd by exploiting structure that single-pass algorithms cannot see across their own metadata.</p>
                <br>
                <p><strong style="color:#e6edf3">Known gap:</strong> General prose and source code ‚Äî the flat-cost literal encoding (10 bits per byte regardless of frequency) is the primary bottleneck vs gzip's adaptive Huffman coding. This is a known and addressable limitation being worked on.</p>
                <br>
                <p>Lower % = better compression. 100% = incompressible data correctly passed through with near-zero overhead.</p>
              </div>

              <footer id="footer">MidMans Bit Folding Algorithm (MBFA) ‚Äî MidManStudio</footer>
            </div>

            <!-- ‚îÄ‚îÄ Detail Modal ‚îÄ‚îÄ -->
            <div class="modal-overlay" id="modal-overlay">
              <div class="modal" role="dialog" aria-modal="true">
                <div class="modal-header">
                  <div>
                    <div class="modal-title" id="modal-title">Dataset</div>
                    <div class="modal-subtitle" id="modal-subtitle"></div>
                  </div>
                  <button class="modal-close" id="modal-close" aria-label="Close">‚úï</button>
                </div>
                <div class="modal-body">

                  <div>
                    <div class="modal-section-label">Summary</div>
                    <div class="stat-grid" id="modal-stats"></div>
                  </div>

                  <div>
                    <div class="modal-section-label">Compression Comparison</div>
                    <div class="cmp-row" id="modal-cmp"></div>
                  </div>

                  <div>
                    <div class="modal-section-label">Fold Pipeline</div>
                    <div class="fold-steps" id="modal-folds"></div>
                  </div>

                </div>
              </div>
            </div>

            <script>
              // ‚îÄ‚îÄ Build meta injected by CI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              const BUILD_META = {
                build:  'BUILD_NUM_PLACEHOLDER',
                branch: 'BRANCH_PLACEHOLDER',
                commit: 'COMMIT_PLACEHOLDER',
                date:   'DATE_PLACEHOLDER'
              };
              document.getElementById('m-build').textContent  = '#' + BUILD_META.build;
              document.getElementById('m-branch').textContent = BUILD_META.branch;
              document.getElementById('m-commit').textContent = BUILD_META.commit;
              document.getElementById('m-date').textContent   = BUILD_META.date;
              document.getElementById('footer').textContent   =
                'MidMans Bit Folding Algorithm (MBFA) ‚Äî MidManStudio ‚Äî Build #' + BUILD_META.build;

              // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              let allData = [];

              // ‚îÄ‚îÄ Load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              fetch('results.json')
                .then(r => r.json())
                .then(data => {
                  allData = data;
                  const tbody = document.getElementById('tbody');
                  let allPass = true;
                  tbody.innerHTML = '';
                  data.forEach((row, idx) => {
                    if (row.mbfa_roundtrip !== 'PASS') allPass = false;
                    const mbfaWin  = parseFloat(row.mbfa_pct) < parseFloat(row.gzip_pct);
                    const mbfaLoss = parseFloat(row.mbfa_pct) > parseFloat(row.gzip_pct);
                    const cls   = mbfaWin ? 'win' : mbfaLoss ? 'loss' : 'tie';
                    const rtcls = row.mbfa_roundtrip === 'PASS' ? 'pass' : 'fail';
                    const scale = v => Math.min(160, Math.round(parseFloat(v) * 1.6));
                    const foldLines = row.fold_detail.split('|').filter(Boolean).join('\n');
                    const tr = document.createElement('tr');
                    tr.dataset.idx = idx;
                    tr.innerHTML = \`
                      <td style="font-weight:600">\${row.dataset.replace(/_/g,' ')}</td>
                      <td>\${(row.original_bytes/1024).toFixed(1)} KB</td>
                      <td class="\${cls}">\${row.mbfa_pct}%<br><span style="color:#8b949e;font-size:0.78rem">\${row.mbfa_ms}ms ‚Ä¢ \${row.mbfa_bytes}B</span></td>
                      <td>\${row.gzip_pct}%<br><span style="color:#8b949e;font-size:0.78rem">\${row.gzip_ms}ms ‚Ä¢ \${row.gzip_bytes}B</span></td>
                      <td style="color:#a371f7">\${row.zstd_pct}%<br><span style="color:#8b949e;font-size:0.78rem">\${row.zstd_ms}ms ‚Ä¢ \${row.zstd_bytes}B</span></td>
                      <td class="\${rtcls}">\${row.mbfa_roundtrip}</td>
                      <td>
                        <div class="bar-row"><div class="bar bar-mbfa" style="width:\${scale(row.mbfa_pct)}px"></div><span style="font-size:0.78rem;color:#f78166">\${row.mbfa_pct}%</span></div>
                        <div class="bar-row"><div class="bar bar-gzip" style="width:\${scale(row.gzip_pct)}px"></div><span style="font-size:0.78rem;color:#79c0ff">\${row.gzip_pct}%</span></div>
                        <div class="bar-row"><div class="bar bar-zstd" style="width:\${scale(row.zstd_pct)}px"></div><span style="font-size:0.78rem;color:#a371f7">\${row.zstd_pct}%</span></div>
                      </td>
                      <td><div class="fold-detail">\${foldLines}</div></td>
                    \`;
                    tr.addEventListener('click', () => openModal(idx));
                    tbody.appendChild(tr);
                  });
                  const banner = document.getElementById('rt-banner');
                  if (allPass) {
                    banner.textContent = '‚úÖ All roundtrip tests passed ‚Äî compress ‚Üí decompress = exact original bytes';
                  } else {
                    banner.className = 'banner fail';
                    banner.textContent = '‚ùå One or more roundtrip tests FAILED ‚Äî check fold detail column';
                  }
                })
                .catch(e => {
                  document.getElementById('tbody').innerHTML =
                    '<tr><td colspan="8" style="color:#f85149;text-align:center;padding:20px">Failed to load results.json: ' + e + '</td></tr>';
                });

              // ‚îÄ‚îÄ Copy button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              document.getElementById('copy-btn').addEventListener('click', () => {
                const btn = document.getElementById('copy-btn');
                const json = JSON.stringify(allData, null, 2);
                navigator.clipboard.writeText(json).then(() => {
                  btn.classList.add('copied');
                  btn.innerHTML = \`
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                      <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
                    </svg>
                    Copied!
                  \`;
                  setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = \`
                      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
                        <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
                      </svg>
                      Copy results.json
                    \`;
                  }, 2000);
                });
              });

              // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              function fmtBytes(n) {
                if (n >= 1024) return (n/1024).toFixed(1) + ' KB';
                return n + ' B';
              }
              function fmtPct(p) {
                const v = parseFloat(p);
                if (v < 1)   return { text: p + '%', color: '#3fb950' };
                if (v < 50)  return { text: p + '%', color: '#3fb950' };
                if (v < 80)  return { text: p + '%', color: '#e3b341' };
                if (v < 100) return { text: p + '%', color: '#f85149' };
                return { text: p + '%', color: '#8b949e' };
              }

              function parseFolds(detail) {
                // detail is pipe-separated lines
                return detail.split('|').filter(Boolean).map(l => l.trim());
              }

              function openModal(idx) {
                const row = allData[idx];
                document.getElementById('modal-title').textContent = row.dataset.replace(/_/g, ' ');
                document.getElementById('modal-subtitle').textContent =
                  fmtBytes(row.original_bytes) + ' original  ‚Ä¢  roundtrip: ' + row.mbfa_roundtrip;

                // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
                const mbfaPct = fmtPct(row.mbfa_pct);
                const saved   = row.original_bytes - row.mbfa_bytes;
                const savedPct = ((saved / row.original_bytes) * 100).toFixed(1);
                const foldLines = parseFolds(row.fold_detail);
                const foldCount = foldLines.filter(l => l.startsWith('Fold')).length;
                // count only folds that were kept (not the "not worth it" one)
                const keptFolds = foldLines.filter(l => /^Fold \d/.test(l) && !l.includes('not worth')).length;

                document.getElementById('modal-stats').innerHTML = \`
                  <div class="stat-card">
                    <div class="stat-label">MBFA Size</div>
                    <div class="stat-value" style="color:\${mbfaPct.color}">\${mbfaPct.text}</div>
                    <div class="stat-sub">\${fmtBytes(row.mbfa_bytes)}</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Space Saved</div>
                    <div class="stat-value" style="color:#3fb950">\${savedPct > 0 ? savedPct + '%' : '‚Äî'}</div>
                    <div class="stat-sub">\${saved > 0 ? fmtBytes(saved) + ' freed' : 'no saving'}</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Encode Time</div>
                    <div class="stat-value">\${row.mbfa_ms}ms</div>
                    <div class="stat-sub">release build</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Folds Used</div>
                    <div class="stat-value" style="color:#79c0ff">\${keptFolds}</div>
                    <div class="stat-sub">\${foldCount > keptFolds ? foldCount + ' attempted' : 'all kept'}</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Roundtrip</div>
                    <div class="stat-value" style="color:\${row.mbfa_roundtrip === 'PASS' ? '#3fb950' : '#f85149'}">\${row.mbfa_roundtrip}</div>
                    <div class="stat-sub">compress ‚Üí decompress</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">vs gzip</div>
                    <div class="stat-value" style="color:\${parseFloat(row.mbfa_pct) < parseFloat(row.gzip_pct) ? '#3fb950' : '#f85149'}">
                      \${parseFloat(row.mbfa_pct) < parseFloat(row.gzip_pct) ? '‚úì Wins' : parseFloat(row.mbfa_pct) === parseFloat(row.gzip_pct) ? 'Tie' : '‚úó Loses'}
                    </div>
                    <div class="stat-sub">gzip: \${row.gzip_pct}%</div>
                  </div>
                \`;

                // ‚îÄ‚îÄ Comparison bars ‚îÄ‚îÄ
                const maxPct = Math.max(parseFloat(row.mbfa_pct), parseFloat(row.gzip_pct), parseFloat(row.zstd_pct), 10);
                const bar = (pct, color) =>
                  \`<div class="cmp-track"><div class="cmp-fill" style="width:\${Math.min(100,(parseFloat(pct)/maxPct)*100).toFixed(1)}%;background:\${color}"></div></div>\`;

                document.getElementById('modal-cmp').innerHTML = \`
                  <div class="cmp-item">
                    <div class="cmp-label" style="color:#f78166">MBFA</div>
                    \${bar(row.mbfa_pct, '#f78166')}
                    <div class="cmp-pct" style="color:#f78166">\${row.mbfa_pct}%</div>
                    <div class="cmp-bytes">\${fmtBytes(row.mbfa_bytes)} ‚Ä¢ \${row.mbfa_ms}ms</div>
                  </div>
                  <div class="cmp-item">
                    <div class="cmp-label" style="color:#79c0ff">gzip</div>
                    \${bar(row.gzip_pct, '#79c0ff')}
                    <div class="cmp-pct" style="color:#79c0ff">\${row.gzip_pct}%</div>
                    <div class="cmp-bytes">\${fmtBytes(row.gzip_bytes)} ‚Ä¢ \${row.gzip_ms}ms</div>
                  </div>
                  <div class="cmp-item">
                    <div class="cmp-label" style="color:#a371f7">zstd</div>
                    \${bar(row.zstd_pct, '#a371f7')}
                    <div class="cmp-pct" style="color:#a371f7">\${row.zstd_pct}%</div>
                    <div class="cmp-bytes">\${fmtBytes(row.zstd_bytes)} ‚Ä¢ \${row.zstd_ms}ms</div>
                  </div>
                \`;

                // ‚îÄ‚îÄ Fold pipeline ‚îÄ‚îÄ
                const lines = parseFolds(row.fold_detail);
                let stepsHtml = '';
                let origBits = 0;

                lines.forEach(line => {
                  if (line.startsWith('Original')) {
                    const m = line.match(/([\d,]+) bits \(([\d,]+) bytes\)/);
                    if (m) origBits = parseInt(m[1].replace(/,/g,''));
                    stepsHtml += \`
                      <div class="fold-step">
                        <div class="fold-step-icon origin">‚Üì</div>
                        <div class="fold-step-content">
                          <div class="fold-step-title">Original Data</div>
                          <div class="fold-step-detail">\${line.replace('Original size: ','')}</div>
                        </div>
                      </div>\`;

                  } else if (/^Fold \d/.test(line) && !line.includes('not worth')) {
                    const mNum  = line.match(/Fold (\d+) \((\w+)\)/);
                    const mSize = line.match(/([\d,]+) bits \(([\d,]+) bytes\)/);
                    const foldBits = mSize ? parseInt(mSize[1].replace(/,/g,'')) : 0;
                    const ratio = origBits > 0 ? ((foldBits / origBits) * 100).toFixed(1) : '‚Äî';
                    const barW  = origBits > 0 ? Math.min(100, (foldBits / origBits) * 100).toFixed(1) : 0;
                    stepsHtml += \`
                      <div class="fold-step">
                        <div class="fold-step-icon fold">F\${mNum ? mNum[1] : '?'}</div>
                        <div class="fold-step-content">
                          <div class="fold-step-title">Fold \${mNum ? mNum[1] : '?'} ‚Äî \${mNum ? mNum[2] : ''}</div>
                          <div class="fold-step-detail">\${mSize ? mSize[1] + ' bits (' + mSize[2] + ' bytes)' : line}</div>
                          <div class="fold-step-bar-wrap">
                            <div class="fold-step-bar-track">
                              <div class="fold-step-bar-fill" style="width:\${barW}%"></div>
                            </div>
                            <div class="fold-step-ratio">\${ratio}% of original</div>
                          </div>
                        </div>
                      </div>\`;

                  } else if (line.includes('not worth')) {
                    stepsHtml += \`
                      <div class="fold-step">
                        <div class="fold-step-icon stop">‚úó</div>
                        <div class="fold-step-content">
                          <div class="fold-step-title" style="color:#f85149">Fold rejected</div>
                          <div class="fold-step-detail">\${line}</div>
                        </div>
                      </div>\`;

                  } else if (line.startsWith('Done')) {
                    stepsHtml += \`
                      <div class="fold-step">
                        <div class="fold-step-icon done">‚úì</div>
                        <div class="fold-step-content">
                          <div class="fold-step-title" style="color:#3fb950">Final output</div>
                          <div class="fold-step-detail">\${line}</div>
                        </div>
                      </div>\`;
                  }
                });

                document.getElementById('modal-folds').innerHTML = stepsHtml;
                document.getElementById('modal-overlay').classList.add('open');
                document.body.style.overflow = 'hidden';
              }

              function closeModal() {
                document.getElementById('modal-overlay').classList.remove('open');
                document.body.style.overflow = '';
              }

              document.getElementById('modal-close').addEventListener('click', closeModal);
              document.getElementById('modal-overlay').addEventListener('click', e => {
                if (e.target === document.getElementById('modal-overlay')) closeModal();
              });
              document.addEventListener('keydown', e => {
                if (e.key === 'Escape') closeModal();
              });
            </script>
          </body>
          </html>
          EOHTML

          # Inject actual build metadata into the placeholders
          sed -i "s/BUILD_NUM_PLACEHOLDER/${BUILD_NUM}/g"  bench_results/index.html
          sed -i "s/BRANCH_PLACEHOLDER/${BRANCH}/g"        bench_results/index.html
          sed -i "s/COMMIT_PLACEHOLDER/${COMMIT:0:8}/g"    bench_results/index.html
          sed -i "s|DATE_PLACEHOLDER|${BUILD_DATE}|g"      bench_results/index.html

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.run_number }}
          path: bench_results/
          retention-days: 90

  deploy-report:
    runs-on: ubuntu-latest
    needs: [parse-commit, benchmark]
    if: needs.parse-commit.outputs.should_publish == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results-${{ github.run_number }}
          path: bench_results

      - name: Deploy to gh-pages
        run: |
          git config --global user.name "MBFA CI"
          git config --global user.email "ci@mbfa.dev"

          mkdir -p /tmp/gh-pages
          git worktree add /tmp/gh-pages gh-pages 2>/dev/null || {
            cd /tmp/gh-pages && git init && git checkout --orphan gh-pages && cd -
          }

          mkdir -p /tmp/gh-pages/builds/build_${{ github.run_number }}
          cp -r bench_results/* /tmp/gh-pages/builds/build_${{ github.run_number }}/
          cp -r bench_results/* /tmp/gh-pages/

          cd /tmp/gh-pages
          git add .
          git commit -m "MBFA benchmark ‚Äî Build #${{ github.run_number }} [skip ci]" || true
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages --force

          echo "Deployed to https://mid-d-man.github.io/mbfa/"

  summary:
    runs-on: ubuntu-latest
    needs: [parse-commit, build-and-test]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "=================================="
          echo "  MBFA ‚Äî MidMans Bit Folding Algorithm"
          echo "  MidManStudio"
          echo "=================================="
          echo "Build:     #${{ github.run_number }}"
          echo "Branch:    ${{ github.ref_name }}"
          echo "Published: ${{ needs.parse-commit.outputs.should_publish }}"
          echo ""
          echo "Use --publish or --deploy in commit message to run benchmarks."
