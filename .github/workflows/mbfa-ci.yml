name: MBFA Build & Benchmark

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  # â”€â”€ Parse commit message for --publish or --deploy flag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  parse-commit:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: Check for publish flag
        id: check
        run: |
          SHOULD_PUBLISH="false"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SHOULD_PUBLISH="true"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            if echo "$COMMIT_MSG" | grep -qiE '\-\-(publish|deploy)'; then
              SHOULD_PUBLISH="true"
            fi
          fi
          echo "should_publish=${SHOULD_PUBLISH}" >> $GITHUB_OUTPUT
          echo "Will publish results: ${SHOULD_PUBLISH}"

  # â”€â”€ Build and test on all platforms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-test:
    runs-on: ${{ matrix.os }}
    needs: parse-commit
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check Formatting
        run: cargo fmt -- --check || true

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings 2>&1 | tee clippy-${{ matrix.os }}.txt || true

      - name: Build Debug
        run: cargo build --verbose 2>&1 | tee build-debug-${{ matrix.os }}.txt

      - name: Build Release
        run: cargo build --release --verbose 2>&1 | tee build-release-${{ matrix.os }}.txt

      - name: Run Tests
        run: cargo test --verbose 2>&1 | tee test-${{ matrix.os }}.txt

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.os }}-${{ github.run_number }}
          path: "*.txt"
          retention-days: 30

  # â”€â”€ Benchmark â€” only runs when --publish or --deploy flag is present â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  benchmark:
    runs-on: ubuntu-latest
    needs: [parse-commit, build-and-test]
    if: needs.parse-commit.outputs.should_publish == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ubuntu-latest-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install benchmark tools
        run: |
          sudo apt-get install -y gzip time
          # zstd
          sudo apt-get install -y zstd || true

      - name: Build Release
        run: cargo build --release

      - name: Prepare benchmark files
        run: |
          mkdir -p bench_files

          # Repetitive text
          python3 -c "print('the the the and the and ' * 500)" > bench_files/repetitive.txt

          # Random bytes
          python3 -c "import os; open('bench_files/random.bin','wb').write(os.urandom(10000))"

          # Source code sample
          cp src/encoder.rs bench_files/source_code.rs

          # Prose â€” Alice in Wonderland
          curl -s -o bench_files/alice.txt "https://www.gutenberg.org/files/11/11-0.txt" || \
            echo "Failed to download alice" > bench_files/alice.txt
          head -c 20000 bench_files/alice.txt > bench_files/alice_small.txt

          # Larger prose for stress test
          head -c 100000 bench_files/alice.txt > bench_files/alice_100k.txt || true

      - name: Run MBFA roundtrip verification
        run: |
          echo "=== Roundtrip Verification ==="
          echo "the the the and the and the cat sat on the mat" > bench_files/roundtrip_test.txt
          ./target/release/mbfa compress bench_files/roundtrip_test.txt bench_files/roundtrip_test.mbfa
          ./target/release/mbfa decompress bench_files/roundtrip_test.mbfa bench_files/roundtrip_recovered.txt
          if diff bench_files/roundtrip_test.txt bench_files/roundtrip_recovered.txt > /dev/null 2>&1; then
            echo "ROUNDTRIP: PASSED"
          else
            echo "ROUNDTRIP: FAILED"
            exit 1
          fi

      - name: Run benchmarks
        run: |
          mkdir -p bench_results

          run_bench() {
            local file=$1
            local name=$2
            local orig_size=$(wc -c < "bench_files/$file")

            # MBFA compress + time
            local mbfa_start=$(date +%s%N)
            ./target/release/mbfa compress "bench_files/$file" "bench_files/$file.mbfa" 2>bench_results/mbfa_log_${name}.txt
            local mbfa_end=$(date +%s%N)
            local mbfa_ms=$(( (mbfa_end - mbfa_start) / 1000000 ))
            local mbfa_size=$(wc -c < "bench_files/$file.mbfa" 2>/dev/null || echo 0)

            # MBFA decompress + verify
            ./target/release/mbfa decompress "bench_files/$file.mbfa" "bench_files/$file.recovered" 2>/dev/null
            local roundtrip="PASS"
            if ! diff "bench_files/$file" "bench_files/$file.recovered" > /dev/null 2>&1; then
              roundtrip="FAIL"
            fi

            # gzip
            local gz_start=$(date +%s%N)
            gzip -k -f "bench_files/$file" 2>/dev/null
            local gz_end=$(date +%s%N)
            local gz_ms=$(( (gz_end - gz_start) / 1000000 ))
            local gz_size=$(wc -c < "bench_files/$file.gz" 2>/dev/null || echo 0)

            # zstd
            local zst_size="N/A"
            local zst_ms="N/A"
            if command -v zstd > /dev/null 2>&1; then
              local zst_start=$(date +%s%N)
              zstd -q -f "bench_files/$file" -o "bench_files/$file.zst" 2>/dev/null
              local zst_end=$(date +%s%N)
              zst_ms=$(( (zst_end - zst_start) / 1000000 ))
              zst_size=$(wc -c < "bench_files/$file.zst" 2>/dev/null || echo 0)
            fi

            local mbfa_pct=$(echo "scale=2; $mbfa_size * 100 / $orig_size" | bc)
            local gz_pct=$(echo "scale=2; $gz_size * 100 / $orig_size" | bc)

            # Read fold info from mbfa log
            local fold_info=$(cat bench_results/mbfa_log_${name}.txt | tr '\n' ' ')

            # Write JSON result
            cat >> bench_results/results.json << EOJSON
          {
            "dataset": "$name",
            "original_bytes": $orig_size,
            "mbfa_bytes": $mbfa_size,
            "mbfa_pct": $mbfa_pct,
            "mbfa_ms": $mbfa_ms,
            "mbfa_roundtrip": "$roundtrip",
            "gzip_bytes": $gz_size,
            "gzip_pct": $gz_pct,
            "gzip_ms": $gz_ms,
            "zstd_bytes": "$zst_size",
            "zstd_ms": "$zst_ms",
            "fold_detail": "$fold_info"
          },
          EOJSON

            printf "%-22s %9s B | MBFA: %6s%% (%sms) | gzip: %6s%% (%sms) | zstd: %s | roundtrip: %s\n" \
              "$name" "$orig_size" "$mbfa_pct" "$mbfa_ms" "$gz_pct" "$gz_ms" "$zst_size" "$roundtrip"
          }

          echo "[]" > bench_results/results.json
          # remove the outer [] so we can append â€” we'll wrap it at the end
          rm bench_results/results.json
          touch bench_results/results.json

          echo "================================================================"
          echo "  MidMans Bit Folding Algorithm (MBFA) â€” Benchmark Results"
          echo "  Build #${{ github.run_number }} | $(date -u)"
          echo "================================================================"

          run_bench "repetitive.txt"  "Repetitive_12KB"
          run_bench "alice_small.txt" "Prose_Alice_20KB"
          run_bench "alice_100k.txt"  "Prose_Alice_100KB"
          run_bench "random.bin"      "Random_10KB"
          run_bench "source_code.rs"  "Source_Code_3KB"

          echo "================================================================"
          echo "Lower % = better compression"

      - name: Generate HTML report
        run: |
          BUILD_DATE=$(date -u)
          BUILD_NUM="${{ github.run_number }}"
          COMMIT="${{ github.sha }}"
          BRANCH="${{ github.ref_name }}"

          cat > bench_results/index.html << EOHTML
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>MBFA Benchmark Results â€” Build #${BUILD_NUM}</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: 'Segoe UI', system-ui, sans-serif;
                background: #0d1117;
                color: #e6edf3;
                padding: 32px 24px;
              }
              .container { max-width: 1100px; margin: 0 auto; }
              header {
                border-bottom: 2px solid #f78166;
                padding-bottom: 20px;
                margin-bottom: 32px;
              }
              header h1 {
                font-size: 2rem;
                color: #f78166;
                letter-spacing: -0.5px;
              }
              header h1 span { color: #e6edf3; }
              .meta {
                display: flex;
                flex-wrap: wrap;
                gap: 16px;
                margin-top: 12px;
              }
              .meta-item {
                background: #161b22;
                border: 1px solid #30363d;
                border-radius: 6px;
                padding: 6px 14px;
                font-size: 0.85rem;
              }
              .meta-item strong { color: #79c0ff; }
              .roundtrip-banner {
                background: #0f2a1a;
                border: 1px solid #2ea043;
                border-radius: 8px;
                padding: 14px 20px;
                margin-bottom: 28px;
                color: #3fb950;
                font-weight: 600;
                font-size: 1rem;
              }
              .roundtrip-banner.fail {
                background: #2a0f0f;
                border-color: #f85149;
                color: #f85149;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                background: #161b22;
                border: 1px solid #30363d;
                border-radius: 8px;
                overflow: hidden;
                margin-bottom: 32px;
                font-size: 0.9rem;
              }
              thead tr { background: #1c2128; }
              th {
                padding: 12px 16px;
                text-align: left;
                color: #8b949e;
                font-weight: 600;
                font-size: 0.8rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-bottom: 1px solid #30363d;
              }
              td {
                padding: 12px 16px;
                border-bottom: 1px solid #21262d;
                vertical-align: top;
              }
              tr:last-child td { border-bottom: none; }
              tr:hover td { background: #1c2128; }
              .win  { color: #3fb950; font-weight: 700; }
              .loss { color: #f85149; }
              .tie  { color: #e3b341; }
              .pass { color: #3fb950; font-weight: 600; }
              .fail { color: #f85149; font-weight: 600; }
              .bar-container {
                display: flex;
                align-items: center;
                gap: 8px;
              }
              .bar {
                height: 10px;
                border-radius: 5px;
                min-width: 2px;
                max-width: 200px;
              }
              .bar-mbfa  { background: #f78166; }
              .bar-gzip  { background: #79c0ff; }
              .bar-label { font-size: 0.85rem; min-width: 55px; }
              .fold-detail {
                font-family: 'Courier New', monospace;
                font-size: 0.75rem;
                color: #8b949e;
                margin-top: 6px;
                line-height: 1.5;
              }
              .section-title {
                font-size: 1.1rem;
                font-weight: 700;
                color: #e6edf3;
                margin-bottom: 12px;
                padding-left: 4px;
                border-left: 3px solid #f78166;
                padding-left: 10px;
              }
              footer {
                margin-top: 48px;
                padding-top: 20px;
                border-top: 1px solid #30363d;
                color: #8b949e;
                font-size: 0.8rem;
                text-align: center;
              }
              .legend {
                display: flex;
                gap: 20px;
                margin-bottom: 12px;
                font-size: 0.82rem;
              }
              .legend-item { display: flex; align-items: center; gap: 6px; }
              .legend-dot {
                width: 10px; height: 10px;
                border-radius: 50%;
                display: inline-block;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <h1>ðŸ¦€ MBFA <span>â€” MidMans Bit Folding Algorithm</span></h1>
                <p style="color:#8b949e; margin-top:6px;">MidManStudio | Benchmark Results</p>
                <div class="meta">
                  <div class="meta-item"><strong>Build:</strong> #${BUILD_NUM}</div>
                  <div class="meta-item"><strong>Branch:</strong> ${BRANCH}</div>
                  <div class="meta-item"><strong>Commit:</strong> ${COMMIT:0:8}</div>
                  <div class="meta-item"><strong>Date:</strong> ${BUILD_DATE}</div>
                </div>
              </header>

              <div class="roundtrip-banner" id="roundtrip-status">
                âœ… All roundtrip tests passed â€” compress â†’ decompress = exact original bytes
              </div>

              <div class="section-title">Compression Results</div>

              <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#f78166"></div> MBFA</div>
                <div class="legend-item"><div class="legend-dot" style="background:#79c0ff"></div> gzip</div>
                <div class="legend-item"><div class="legend-dot" style="background:#a371f7"></div> zstd</div>
              </div>

              <table id="results-table">
                <thead>
                  <tr>
                    <th>Dataset</th>
                    <th>Original</th>
                    <th>MBFA</th>
                    <th>gzip</th>
                    <th>zstd</th>
                    <th>Roundtrip</th>
                    <th>Visual</th>
                    <th>Fold Detail</th>
                  </tr>
                </thead>
                <tbody id="results-body">
                  <tr><td colspan="8" style="color:#8b949e; text-align:center; padding:20px;">Loading results...</td></tr>
                </tbody>
              </table>

              <div class="section-title" style="margin-top:32px;">Notes</div>
              <div style="background:#161b22; border:1px solid #30363d; border-radius:8px; padding:20px; font-size:0.88rem; line-height:1.8; color:#8b949e;">
                <p>Lower % = better compression. 100% means no compression achieved (data passed through).</p>
                <p>MBFA is a multi-fold iterative instruction-chain compressor. Fold 1 uses LZ77-style matching. Fold 2 uses token pair encoding with Cantor-paired operands when input > 512 bytes.</p>
                <p>gzip uses DEFLATE (LZ77 + Huffman). zstd uses LZ + FSE (Finite State Entropy). Both use adaptive entropy coding which MBFA does not yet implement.</p>
                <p>MBFA's advantage is on highly repetitive data where multi-fold convergence dramatically outperforms single-pass algorithms.</p>
              </div>

              <footer>
                MidMans Bit Folding Algorithm (MBFA) â€” MidManStudio â€” Build #${BUILD_NUM}
              </footer>
            </div>

            <script>
              // Parse fold detail from log lines and populate table
              const raw = document.getElementById('results-body');

              fetch('results.json')
                .then(r => r.json())
                .then(data => {
                  raw.innerHTML = '';
                  let allPass = true;
                  data.forEach(row => {
                    if (row.mbfa_roundtrip !== 'PASS') allPass = false;
                    const mbfaWin  = parseFloat(row.mbfa_pct) < parseFloat(row.gzip_pct);
                    const mbfaLoss = parseFloat(row.mbfa_pct) > parseFloat(row.gzip_pct);
                    const mbfaClass = mbfaWin ? 'win' : mbfaLoss ? 'loss' : 'tie';
                    const rtClass  = row.mbfa_roundtrip === 'PASS' ? 'pass' : 'fail';
                    const mbfaBar  = Math.min(200, Math.round(parseFloat(row.mbfa_pct) * 2));
                    const gzBar    = Math.min(200, Math.round(parseFloat(row.gzip_pct) * 2));
                    const foldLines = row.fold_detail.split('Fold').filter(Boolean).map(l => 'Fold' + l).join('<br>');
                    raw.innerHTML += \`
                      <tr>
                        <td style="font-weight:600">\${row.dataset.replace(/_/g,' ')}</td>
                        <td>\${(row.original_bytes/1024).toFixed(1)} KB</td>
                        <td class="\${mbfaClass}">\${row.mbfa_pct}% <span style="color:#8b949e;font-size:0.8rem">(\${row.mbfa_ms}ms)</span></td>
                        <td>\${row.gzip_pct}% <span style="color:#8b949e;font-size:0.8rem">(\${row.gzip_ms}ms)</span></td>
                        <td style="color:#8b949e">\${row.zstd_bytes === 'N/A' ? 'N/A' : row.zstd_bytes + ' B'}</td>
                        <td class="\${rtClass}">\${row.mbfa_roundtrip}</td>
                        <td>
                          <div class="bar-container">
                            <div class="bar bar-mbfa" style="width:\${mbfaBar}px"></div>
                            <span class="bar-label" style="color:#f78166">\${row.mbfa_pct}%</span>
                          </div>
                          <div class="bar-container" style="margin-top:4px">
                            <div class="bar bar-gzip" style="width:\${gzBar}px"></div>
                            <span class="bar-label" style="color:#79c0ff">\${row.gzip_pct}%</span>
                          </div>
                        </td>
                        <td><div class="fold-detail">\${foldLines}</div></td>
                      </tr>\`;
                  });
                  if (!allPass) {
                    document.getElementById('roundtrip-status').className = 'roundtrip-banner fail';
                    document.getElementById('roundtrip-status').textContent = 'âŒ One or more roundtrip tests FAILED';
                  }
                })
                .catch(() => {
                  raw.innerHTML = '<tr><td colspan="8" style="color:#f85149;text-align:center;padding:20px;">Failed to load results.json</td></tr>';
                });
            </script>
          </body>
          </html>
          EOHTML

          echo "HTML report generated"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.run_number }}
          path: bench_results/
          retention-days: 90

  # â”€â”€ Deploy HTML report to gh-pages when --publish/--deploy is used â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-report:
    runs-on: ubuntu-latest
    needs: [parse-commit, benchmark]
    if: needs.parse-commit.outputs.should_publish == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results-${{ github.run_number }}
          path: bench_results

      - name: Deploy to gh-pages
        run: |
          git config --global user.name "MBFA CI"
          git config --global user.email "ci@mbfa.dev"

          git fetch origin gh-pages 2>/dev/null || true

          # Work in a temp dir
          mkdir -p /tmp/gh-pages

          # Try to restore existing history
          git worktree add /tmp/gh-pages gh-pages 2>/dev/null || {
            mkdir -p /tmp/gh-pages
            cd /tmp/gh-pages
            git init
            git checkout --orphan gh-pages
            cd -
          }

          # Copy latest results into a build-numbered folder AND root
          mkdir -p /tmp/gh-pages/builds/build_${{ github.run_number }}
          cp -r bench_results/* /tmp/gh-pages/builds/build_${{ github.run_number }}/
          cp -r bench_results/* /tmp/gh-pages/

          # Generate a simple index listing all builds
          cat > /tmp/gh-pages/builds/index.html << 'EOIDX'
          <!DOCTYPE html>
          <html>
          <head>
            <title>MBFA â€” All Benchmark Builds</title>
            <style>
              body { font-family: system-ui; background:#0d1117; color:#e6edf3; padding:32px; }
              h1 { color:#f78166; }
              ul { margin-top:20px; }
              li { margin:8px 0; }
              a { color:#79c0ff; }
            </style>
          </head>
          <body>
            <h1>ðŸ¦€ MBFA â€” Benchmark History</h1>
            <ul id="list"></ul>
            <script>
              // Auto-list folders â€” relies on directory listing or manual maintenance
              document.getElementById('list').innerHTML =
                '<li><a href="../index.html">Latest build</a></li>';
            </script>
          </body>
          </html>
          EOIDX

          cd /tmp/gh-pages
          git add .
          git commit -m "MBFA benchmark results â€” Build #${{ github.run_number }} [skip ci]" || true
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages --force

          echo "âœ… Deployed to GitHub Pages"
          echo "View at: https://mid-d-man.github.io/mbfa/"

  # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    runs-on: ubuntu-latest
    needs: [parse-commit, build-and-test]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "=================================="
          echo "  MBFA â€” MidMans Bit Folding Algorithm"
          echo "  MidManStudio"
          echo "=================================="
          echo "Build:     #${{ github.run_number }}"
          echo "Branch:    ${{ github.ref_name }}"
          echo "Commit:    ${{ github.sha }}"
          echo "Published: ${{ needs.parse-commit.outputs.should_publish }}"
          echo ""
          echo "Add --publish or --deploy to your commit message to run"
          echo "full benchmarks and deploy the HTML report to GitHub Pages."
