<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MBFA â€” Canterbury Corpus | Build #BUILD_NUM_PLACEHOLDER</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0d1117; color: #e6edf3; padding: 32px 24px; }
    .container { max-width: 1300px; margin: 0 auto; }

    header { border-bottom: 2px solid #79c0ff; padding-bottom: 20px; margin-bottom: 28px; }
    header h1 { font-size: 1.9rem; color: #79c0ff; }
    header h1 span { color: #e6edf3; }
    .back-link { display: inline-flex; align-items: center; gap: 6px; color: #8b949e;
      font-size: 0.82rem; text-decoration: none; margin-bottom: 14px;
      padding: 5px 12px; background: #161b22; border: 1px solid #30363d;
      border-radius: 6px; transition: color 0.15s, border-color 0.15s; }
    .back-link:hover { color: #e6edf3; border-color: #8b949e; }
    .meta { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; }
    .meta-item { background: #161b22; border: 1px solid #30363d; border-radius: 6px;
      padding: 5px 12px; font-size: 0.82rem; }
    .meta-item strong { color: #79c0ff; }

    /* Summary cards */
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px; margin-bottom: 28px; }
    .summary-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px;
      padding: 14px 16px; }
    .summary-card .label { font-size: 0.7rem; text-transform: uppercase;
      letter-spacing: 0.6px; color: #484f58; margin-bottom: 6px; }
    .summary-card .value { font-size: 1.4rem; font-weight: 700; }
    .summary-card .sub { font-size: 0.72rem; color: #8b949e; margin-top: 3px; }

    /* About box */
    .about { background: #0f1e3a; border: 1px solid #1f4080; border-radius: 8px;
      padding: 14px 18px; margin-bottom: 24px; font-size: 0.83rem;
      color: #8b949e; line-height: 1.7; }
    .about strong { color: #79c0ff; }

    /* Table */
    .toolbar { display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
    .section-title { font-size: 1rem; font-weight: 700; border-left: 3px solid #79c0ff;
      padding-left: 10px; }
    .legend { display: flex; flex-wrap: wrap; gap: 14px; font-size: 0.79rem; margin-bottom: 8px; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .click-hint { font-size: 0.72rem; color: #484f58; margin-bottom: 8px; }

    table { width: 100%; border-collapse: collapse; background: #161b22;
      border: 1px solid #30363d; border-radius: 8px; overflow: hidden;
      margin-bottom: 32px; font-size: 0.83rem; }
    thead tr { background: #1c2128; }
    th { padding: 9px 11px; text-align: left; color: #8b949e; font-size: 0.70rem;
      text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 1px solid #30363d; white-space: nowrap; }
    td { padding: 9px 11px; border-bottom: 1px solid #21262d; vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tbody tr { cursor: pointer; }
    tbody tr:hover td { background: #1c2128; }

    .win  { color: #3fb950; font-weight: 700; }
    .loss { color: #f85149; }
    .sub  { color: #8b949e; font-size: 0.73rem; }
    .rank-1 { color: #f1c40f; font-weight: 700; }
    .rank-2 { color: #8b949e; font-weight: 600; }
    .rank-3 { color: #cd7f32; }
    .rank-bad { color: #484f58; }

    .badge { display: inline-block; font-size: 0.63rem; font-weight: 700;
      padding: 2px 6px; border-radius: 10px; text-transform: uppercase;
      letter-spacing: 0.4px; margin-left: 5px; vertical-align: middle; }
    .badge-text   { background:#0f1e3a; color:#79c0ff; border:1px solid #1f4080; }
    .badge-html   { background:#2a1a0f; color:#f0883e; border:1px solid #5a3a1a; }
    .badge-source { background:#1a2a0f; color:#56d364; border:1px solid #2a5a1a; }
    .badge-lisp   { background:#1a0f2a; color:#a371f7; border:1px solid #3a1a5a; }
    .badge-sheet  { background:#0f2a1a; color:#3fb950; border:1px solid #1a5a2a; }
    .badge-bin    { background:#1c2128; color:#8b949e; border:1px solid #30363d; }
    .badge-exe    { background:#2a0f0f; color:#f85149; border:1px solid #5a1a1a; }

    .bar-row { display: flex; align-items: center; gap: 4px; margin-bottom: 2px; }
    .bar { height: 6px; border-radius: 3px; min-width: 1px; }

    /* Rank chart */
    .rank-bar-wrap { display: flex; flex-direction: column; gap: 3px; }
    .rank-bar-item { display: flex; align-items: center; gap: 6px; font-size: 0.72rem; }
    .rank-num { width: 14px; color: #484f58; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.72); z-index: 1000;
      align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: #161b22; border: 1px solid #30363d; border-radius: 12px;
      width: 100%; max-width: 680px; max-height: 88vh;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 24px 64px rgba(0,0,0,0.6);
      animation: modal-in 0.15s ease; }
    @keyframes modal-in { from { transform: translateY(16px); opacity:0; } to { transform:none; opacity:1; } }
    .modal-header { display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid #30363d; flex-shrink: 0; }
    .modal-title { font-size: 1rem; font-weight: 700; color: #79c0ff; }
    .modal-close { background: #21262d; border: 1px solid #30363d; color: #8b949e;
      width: 30px; height: 30px; border-radius: 6px; font-size: 1rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: #2d333b; color: #e6edf3; }
    .modal-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 18px; }
    .modal-section-label { font-size: 0.68rem; text-transform: uppercase;
      letter-spacing: 0.8px; color: #484f58; font-weight: 600; margin-bottom: 8px; }
    .cmp-row { display: flex; flex-direction: column; gap: 7px; }
    .cmp-item { display: grid; grid-template-columns: 60px 1fr 58px 70px;
      align-items: center; gap: 8px; }
    .cmp-label { font-size: 0.76rem; color: #8b949e; }
    .cmp-track { background: #0d1117; border-radius: 3px; height: 9px; overflow: hidden; }
    .cmp-fill  { height: 100%; border-radius: 3px; }
    .cmp-pct   { font-size: 0.80rem; font-weight: 700; text-align: right; }
    .cmp-bytes { font-size: 0.70rem; color: #484f58; text-align: right; }
    .fold-detail-box { font-family: monospace; font-size: 0.72rem;
      color: #8b949e; background: #0d1117; border: 1px solid #21262d;
      border-radius: 6px; padding: 12px; line-height: 1.7; white-space: pre-wrap; }

    footer { margin-top: 32px; padding-top: 14px; border-top: 1px solid #30363d;
      color: #8b949e; font-size: 0.76rem; text-align: center; }
    .copy-btn { background: #21262d; border: 1px solid #30363d; color: #e6edf3;
      padding: 6px 14px; border-radius: 6px; font-size: 0.80rem; cursor: pointer;
      display: flex; align-items: center; gap: 6px; transition: background 0.15s; }
    .copy-btn:hover { background: #2d333b; }
    .copy-btn.copied { background: #0f2a1a; border-color: #2ea043; color: #3fb950; }
  </style>
</head>
<body>
<div class="container">
  <a class="back-link" href="../">&#x2190; Main Benchmarks</a>

  <header>
    <h1>&#x1F4DA; MBFA <span>&#x2014; Canterbury Corpus Benchmark</span></h1>
    <p style="color:#8b949e;margin-top:5px">MidManStudio | Standard compression research benchmark suite</p>
    <div class="meta">
      <div class="meta-item"><strong>Build:</strong> #BUILD_NUM_PLACEHOLDER</div>
      <div class="meta-item"><strong>Branch:</strong> BRANCH_PLACEHOLDER</div>
      <div class="meta-item"><strong>Commit:</strong> COMMIT_PLACEHOLDER</div>
      <div class="meta-item"><strong>Date:</strong> DATE_PLACEHOLDER</div>
    </div>
  </header>

  <div class="about">
    <strong>The Canterbury Corpus</strong> is the standard benchmark dataset used in academic
    compression research since 1997. It covers a representative spread of real-world file
    types â€” English prose, source code, HTML, binary data, executables, and spreadsheets.
    Results on this corpus are directly comparable to published compression research.
    Lower % = better compression. All MBFA roundtrips must pass for results to be valid.
  </div>

  <div class="summary-grid" id="summary-grid">
    <div class="summary-card">
      <div class="label">Files tested</div>
      <div class="value" id="stat-files">â€”</div>
      <div class="sub">Canterbury corpus</div>
    </div>
    <div class="summary-card">
      <div class="label">MBFA wins</div>
      <div class="value win" id="stat-wins">â€”</div>
      <div class="sub">best ratio per file</div>
    </div>
    <div class="summary-card">
      <div class="label">Roundtrips</div>
      <div class="value" id="stat-rt">â€”</div>
      <div class="sub">compress â†’ decompress</div>
    </div>
    <div class="summary-card">
      <div class="label">Avg MBFA ratio</div>
      <div class="value" id="stat-avg">â€”</div>
      <div class="sub">across all files</div>
    </div>
    <div class="summary-card">
      <div class="label">vs gzip avg</div>
      <div class="value" id="stat-vs-gzip">â€”</div>
      <div class="sub">negative = MBFA wins</div>
    </div>
    <div class="summary-card">
      <div class="label">vs zstd avg</div>
      <div class="value" id="stat-vs-zstd">â€”</div>
      <div class="sub">negative = MBFA wins</div>
    </div>
  </div>

  <div class="toolbar">
    <div class="section-title">Results by File</div>
    <button class="copy-btn" id="copy-btn">
      <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor">
        <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
        <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
      </svg>
      Copy results.json
    </button>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="dot" style="background:#f78166"></div>MBFA</div>
    <div class="legend-item"><div class="dot" style="background:#79c0ff"></div>gzip</div>
    <div class="legend-item"><div class="dot" style="background:#a371f7"></div>zstd</div>
    <div class="legend-item"><div class="dot" style="background:#e3b341"></div>xz</div>
    <div class="legend-item"><div class="dot" style="background:#3fb950"></div>brotli</div>
    <div class="legend-item"><div class="dot" style="background:#ff7b72"></div>zpaq</div>
    <div class="legend-item" style="margin-left:auto">
      <span style="color:#f1c40f;font-size:0.78rem">&#x1F947; = best for that file</span>
    </div>
  </div>
  <p class="click-hint">&#x1F4A1; Click any row for breakdown and fold pipeline</p>

  <table>
    <thead>
      <tr>
        <th>File</th>
        <th>Size</th>
        <th>MBFA</th>
        <th>gzip</th>
        <th>zstd</th>
        <th>xz</th>
        <th>brotli</th>
        <th>zpaq</th>
        <th>Rank</th>
        <th>Bars</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <footer>
    MBFA Canterbury Corpus â€” MidManStudio â€” Build #BUILD_NUM_PLACEHOLDER
  </footer>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">File</div>
      <button class="modal-close" id="modal-close">&#x2715;</button>
    </div>
    <div class="modal-body">
      <div>
        <div class="modal-section-label">Compression Comparison</div>
        <div class="cmp-row" id="modal-cmp"></div>
      </div>
      <div>
        <div class="modal-section-label">Fold Pipeline</div>
        <div class="fold-detail-box" id="modal-fold"></div>
      </div>
    </div>
  </div>
</div>

<script>
  let allData = [];

  const COLORS = {
    mbfa:'#f78166', gzip:'#79c0ff', zstd:'#a371f7',
    xz:'#e3b341', brotli:'#3fb950', zpaq:'#ff7b72'
  };

  function fmtBytes(n) {
    return n >= 1048576 ? (n/1048576).toFixed(1)+' MB'
         : n >= 1024    ? (n/1024).toFixed(1)+' KB'
         : n + ' B';
  }

  function badgeCls(type) {
    const t = (type||'').toLowerCase();
    if (t === 'text')        return 'badge-text';
    if (t === 'html')        return 'badge-html';
    if (t === 'source')      return 'badge-source';
    if (t === 'lisp')        return 'badge-lisp';
    if (t === 'spreadsheet') return 'badge-sheet';
    if (t === 'executable')  return 'badge-exe';
    return 'badge-bin';
  }

  function rankClass(r) {
    if (r === 1) return 'rank-1';
    if (r === 2) return 'rank-2';
    if (r === 3) return 'rank-3';
    return 'rank-bad';
  }

  function rankEmoji(r) {
    if (r === 1) return 'ðŸ¥‡';
    if (r === 2) return 'ðŸ¥ˆ';
    if (r === 3) return 'ðŸ¥‰';
    return `#${r}`;
  }

  fetch('results.json')
    .then(r => r.json())
    .then(data => {
      allData = data;
      const tbody = document.getElementById('tbody');

      // Summary stats
      const n = data.length;
      let wins = 0, rtPass = 0;
      let sumMbfa = 0, sumGzip = 0, sumZstd = 0;

      data.forEach(row => {
        const m = parseFloat(row.mbfa_pct);
        const g = parseFloat(row.gzip_pct);
        const z = parseFloat(row.zstd_pct);
        const x = parseFloat(row.xz_pct);
        const b = parseFloat(row.brotli_pct);
        const p = parseFloat(row.zpaq_pct);
        if (m <= Math.min(g, z, x, b, p)) wins++;
        if (row.mbfa_roundtrip === 'PASS') rtPass++;
        sumMbfa += m; sumGzip += g; sumZstd += z;
      });

      document.getElementById('stat-files').textContent = n;
      document.getElementById('stat-wins').textContent  = wins;
      document.getElementById('stat-rt').textContent    = rtPass === n ? `${n}/${n} âœ…` : `${rtPass}/${n} âŒ`;
      document.getElementById('stat-avg').textContent   = (sumMbfa/n).toFixed(1) + '%';
      const vg = ((sumMbfa - sumGzip)/n).toFixed(1);
      const vz = ((sumMbfa - sumZstd)/n).toFixed(1);
      const gEl = document.getElementById('stat-vs-gzip');
      const zEl = document.getElementById('stat-vs-zstd');
      gEl.textContent = (parseFloat(vg) <= 0 ? '' : '+') + vg + 'pp';
      zEl.textContent = (parseFloat(vz) <= 0 ? '' : '+') + vz + 'pp';
      gEl.className = 'value ' + (parseFloat(vg) <= 0 ? 'win' : 'loss');
      zEl.className = 'value ' + (parseFloat(vz) <= 0 ? 'win' : 'loss');

      data.forEach((row, idx) => {
        const m    = parseFloat(row.mbfa_pct);
        const g    = parseFloat(row.gzip_pct);
        const best = Math.min(m, g, parseFloat(row.zstd_pct),
                              parseFloat(row.xz_pct), parseFloat(row.brotli_pct),
                              parseFloat(row.zpaq_pct));
        const mbfaWins = m <= best;
        const rank     = row.mbfa_rank;
        const scale    = v => Math.min(130, Math.round(parseFloat(v) * 1.3));

        function cell(pct, color) {
          const isB = parseFloat(pct) <= best;
          return `<td style="color:${isB ? color : ''}" class="${isB ? 'win' : ''}">
            ${pct}%</td>`;
        }

        const tr = document.createElement('tr');
        tr.dataset.idx = idx;
        tr.innerHTML =
          `<td style="font-weight:600">${row.file}
             <span class="badge ${badgeCls(row.type)}">${row.type}</span></td>` +
          `<td>${fmtBytes(row.original_bytes)}</td>` +
          cell(row.mbfa_pct,   COLORS.mbfa) +
          cell(row.gzip_pct,   COLORS.gzip) +
          cell(row.zstd_pct,   COLORS.zstd) +
          cell(row.xz_pct,     COLORS.xz)   +
          cell(row.brotli_pct, COLORS.brotli)+
          cell(row.zpaq_pct,   COLORS.zpaq)  +
          `<td class="${rankClass(rank)}">${rankEmoji(rank)}</td>` +
          `<td>
            ${Object.entries({mbfa:row.mbfa_pct,gzip:row.gzip_pct,zstd:row.zstd_pct,
                               xz:row.xz_pct,brotli:row.brotli_pct,zpaq:row.zpaq_pct})
              .map(([k,v]) =>
                `<div class="bar-row">
                   <div class="bar" style="background:${COLORS[k]};width:${scale(v)}px"></div>
                   <span style="font-size:0.70rem;color:${COLORS[k]}">${v}%</span>
                 </div>`
              ).join('')}
          </td>`;

        tr.addEventListener('click', () => openModal(idx));
        tbody.appendChild(tr);
      });
    })
    .catch(e => {
      document.getElementById('tbody').innerHTML =
        `<tr><td colspan="10" style="color:#f85149;text-align:center;padding:20px">
           Failed to load results.json: ${e}</td></tr>`;
    });

  document.getElementById('copy-btn').addEventListener('click', function() {
    navigator.clipboard.writeText(JSON.stringify(allData, null, 2)).then(() => {
      this.classList.add('copied');
      this.textContent = 'âœ“ Copied!';
      setTimeout(() => {
        this.classList.remove('copied');
        this.innerHTML = `<svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor">
          <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
          <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
        </svg> Copy results.json`;
      }, 2000);
    });
  });

  function openModal(idx) {
    const row = allData[idx];
    document.getElementById('modal-title').textContent =
      `${row.file} â€” ${fmtBytes(row.original_bytes)}`;

    const algos = [
      {k:'mbfa',   pct:row.mbfa_pct,   bytes:row.mbfa_bytes,   ms:row.mbfa_ms},
      {k:'gzip',   pct:row.gzip_pct,   bytes:row.gzip_bytes,   ms:row.gzip_ms},
      {k:'zstd',   pct:row.zstd_pct,   bytes:row.zstd_bytes,   ms:row.zstd_ms},
      {k:'xz',     pct:row.xz_pct,     bytes:row.xz_bytes,     ms:row.xz_ms},
      {k:'brotli', pct:row.brotli_pct, bytes:row.brotli_bytes, ms:row.brotli_ms},
      {k:'zpaq',   pct:row.zpaq_pct,   bytes:row.zpaq_bytes,   ms:row.zpaq_ms},
    ];
    const maxPct = Math.max(...algos.map(a => parseFloat(a.pct)));

    document.getElementById('modal-cmp').innerHTML = algos.map(a => {
      const w = Math.min(100, (parseFloat(a.pct)/maxPct)*100).toFixed(1);
      const c = COLORS[a.k];
      return `<div class="cmp-item">
        <div class="cmp-label" style="color:${c}">${a.k}</div>
        <div class="cmp-track">
          <div class="cmp-fill" style="width:${w}%;background:${c}"></div>
        </div>
        <div class="cmp-pct" style="color:${c}">${a.pct}%</div>
        <div class="cmp-bytes">${fmtBytes(a.bytes)} Â· ${a.ms}ms</div>
      </div>`;
    }).join('');

    const detail = (row.fold_detail || '').split('|').filter(Boolean).join('\n');
    document.getElementById('modal-fold').textContent = detail || 'No fold detail available';

    document.getElementById('modal-overlay').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    document.getElementById('modal-overlay').classList.remove('open');
    document.body.style.overflow = '';
  }
  document.getElementById('modal-close').addEventListener('click', closeModal);
  document.getElementById('modal-overlay').addEventListener('click', e => {
    if (e.target === document.getElementById('modal-overlay')) closeModal();
  });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
</script>
</body>
  </html>
