<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MBFA Benchmark Results â€” Build #125</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0d1117; color: #e6edf3; padding: 32px 24px; }
    .container { max-width: 1300px; margin: 0 auto; }
    header { border-bottom: 2px solid #f78166; padding-bottom: 20px; margin-bottom: 32px; }
    header h1 { font-size: 2rem; color: #f78166; }
    header h1 span { color: #e6edf3; }
    .meta { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 12px; }
    .meta-item { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 6px 14px; font-size: 0.85rem; }
    .meta-item strong { color: #79c0ff; }
    .banner { background: #0f2a1a; border: 1px solid #2ea043; border-radius: 8px; padding: 14px 20px; margin-bottom: 28px; color: #3fb950; font-weight: 600; }
    .banner.fail { background: #2a0f0f; border-color: #f85149; color: #f85149; }
    .toolbar { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
    .copy-btn { background: #21262d; border: 1px solid #30363d; color: #e6edf3; padding: 7px 16px; border-radius: 6px; font-size: 0.82rem; cursor: pointer; display: flex; align-items: center; gap: 7px; transition: background 0.15s, border-color 0.15s; }
    .copy-btn:hover { background: #2d333b; border-color: #8b949e; }
    .copy-btn.copied { background: #0f2a1a; border-color: #2ea043; color: #3fb950; }
    .copy-btn svg { flex-shrink: 0; }
    table { width: 100%; border-collapse: collapse; background: #161b22; border: 1px solid #30363d; border-radius: 8px; overflow: hidden; margin-bottom: 32px; font-size: 0.85rem; }
    thead tr { background: #1c2128; }
    th { padding: 10px 12px; text-align: left; color: #8b949e; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #30363d; white-space: nowrap; }
    td { padding: 10px 12px; border-bottom: 1px solid #21262d; vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tbody tr { cursor: pointer; }
    tbody tr:hover td { background: #1c2128; }
    .win  { color: #3fb950; font-weight: 700; }
    .loss { color: #f85149; }
    .tie  { color: #e3b341; }
    .pass { color: #3fb950; font-weight: 600; }
    .fail-rt { color: #f85149; font-weight: 600; }
    .sub  { color: #8b949e; font-size: 0.75rem; }
    .bar-row { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
    .bar { height: 7px; border-radius: 4px; min-width: 2px; }
    .bar-mbfa  { background: #f78166; }
    .bar-gzip  { background: #79c0ff; }
    .bar-zstd  { background: #a371f7; }
    .bar-xz    { background: #e3b341; }
    .bar-br    { background: #3fb950; }
    .bar-zpaq  { background: #ff7b72; }
    .fold-detail { font-family: monospace; font-size: 0.7rem; color: #8b949e; line-height: 1.6; white-space: pre-wrap; }
    .section-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 12px; border-left: 3px solid #f78166; padding-left: 10px; }
    footer { margin-top: 40px; padding-top: 16px; border-top: 1px solid #30363d; color: #8b949e; font-size: 0.78rem; text-align: center; }
    .legend { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 10px; font-size: 0.8rem; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .dot { width: 9px; height: 9px; border-radius: 50%; display: inline-block; }
    .notes { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 18px; font-size: 0.85rem; line-height: 1.8; color: #8b949e; }
    .click-hint { font-size: 0.72rem; color: #484f58; margin-bottom: 10px; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.72); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: #161b22; border: 1px solid #30363d; border-radius: 12px; width: 100%; max-width: 720px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 24px 64px rgba(0,0,0,0.6); animation: modal-in 0.18s ease; }
    @keyframes modal-in { from { transform: translateY(18px); opacity: 0; } to { transform: none; opacity: 1; } }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 22px; border-bottom: 1px solid #30363d; flex-shrink: 0; }
    .modal-title { font-size: 1.1rem; font-weight: 700; color: #f78166; }
    .modal-subtitle { font-size: 0.78rem; color: #8b949e; margin-top: 3px; }
    .modal-close { background: #21262d; border: 1px solid #30363d; color: #8b949e; width: 32px; height: 32px; border-radius: 6px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.15s, color 0.15s; flex-shrink: 0; }
    .modal-close:hover { background: #2d333b; color: #e6edf3; }
    .modal-body { padding: 22px; overflow-y: auto; display: flex; flex-direction: column; gap: 22px; }
    .modal-section-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.8px; color: #484f58; font-weight: 600; margin-bottom: 10px; }
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .stat-card { background: #0d1117; border: 1px solid #21262d; border-radius: 8px; padding: 12px 14px; }
    .stat-card .stat-label { font-size: 0.72rem; color: #8b949e; margin-bottom: 4px; }
    .stat-card .stat-value { font-size: 1.05rem; font-weight: 700; }
    .stat-card .stat-sub { font-size: 0.72rem; color: #484f58; margin-top: 2px; }
    .cmp-row { display: flex; flex-direction: column; gap: 8px; }
    .cmp-item { display: grid; grid-template-columns: 64px 1fr 64px 72px; align-items: center; gap: 10px; }
    .cmp-label { font-size: 0.78rem; color: #8b949e; }
    .cmp-track { background: #0d1117; border-radius: 4px; height: 10px; overflow: hidden; }
    .cmp-fill { height: 100%; border-radius: 4px; }
    .cmp-pct { font-size: 0.82rem; font-weight: 700; text-align: right; }
    .cmp-bytes { font-size: 0.72rem; color: #484f58; text-align: right; }
    .fold-steps { display: flex; flex-direction: column; gap: 0; }
    .fold-step { display: flex; gap: 14px; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #21262d; }
    .fold-step:last-child { border-bottom: none; }
    .fold-step-icon { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.72rem; font-weight: 700; margin-top: 1px; }
    .fold-step-icon.origin { background: #1c2128; border: 1px solid #30363d; color: #8b949e; }
    .fold-step-icon.fold   { background: #0f1e3a; border: 1px solid #1f4080; color: #79c0ff; }
    .fold-step-icon.entropy{ background: #1a0f2a; border: 1px solid #6e3db5; color: #a371f7; }
    .fold-step-icon.stop   { background: #2a0f0f; border: 1px solid #5a1a1a; color: #f85149; }
    .fold-step-icon.done   { background: #0f2a1a; border: 1px solid #1a5a2a; color: #3fb950; }
    .fold-step-content { flex: 1; }
    .fold-step-title { font-size: 0.85rem; font-weight: 600; color: #e6edf3; }
    .fold-step-detail { font-size: 0.78rem; color: #8b949e; margin-top: 3px; }
    .fold-step-bar-track { background: #0d1117; border-radius: 3px; height: 6px; overflow: hidden; margin-top: 6px; }
    .fold-step-bar-fill { height: 100%; border-radius: 3px; background: #79c0ff; }
    .fold-step-ratio { font-size: 0.7rem; color: #484f58; margin-top: 3px; }

    /* Category badges */
    .badge { display: inline-block; font-size: 0.65rem; font-weight: 700; padding: 2px 7px; border-radius: 10px; text-transform: uppercase; letter-spacing: 0.4px; margin-left: 6px; vertical-align: middle; }
    .badge-text  { background: #0f1e3a; color: #79c0ff; border: 1px solid #1f4080; }
    .badge-json  { background: #1a2a0f; color: #56d364; border: 1px solid #2a5a1a; }
    .badge-audio { background: #2a1a0f; color: #f0883e; border: 1px solid #5a3a1a; }
    .badge-image { background: #1a0f2a; color: #a371f7; border: 1px solid #3a1a5a; }
    .badge-bin   { background: #1c2128; color: #8b949e; border: 1px solid #30363d; }
  </style>
</head>
<body>
  <div class="container">
<header>
      <h1>&#x1F980; MBFA <span>&#x2014; MidMans Bit Folding Algorithm</span></h1>
      <p style="color:#8b949e;margin-top:6px;">MidManStudio | Extended Benchmark Results</p>
      <div class="meta">
        <div class="meta-item"><strong>Build:</strong> #125</div>
        <div class="meta-item"><strong>Branch:</strong> master</div>
        <div class="meta-item"><strong>Commit:</strong> 5d221981</div>
        <div class="meta-item"><strong>Date:</strong> Thu Feb 26 20:29:36 UTC 2026</div>
        <a href="corpus/" style="display:inline-flex;align-items:center;gap:6px;
          background:#0f1e3a;border:1px solid #1f4080;color:#79c0ff;
          padding:5px 14px;border-radius:6px;font-size:0.82rem;
          text-decoration:none;margin-top:2px;transition:background 0.15s;"
          onmouseover="this.style.background='#1c2f5a'"
          onmouseout="this.style.background='#0f1e3a'">
          &#x1F4DA; Canterbury Corpus &#x2192;
        </a>
        <a href="./visual.html"
   style="display:inline-flex;align-items:center;gap:6px;
          background:rgba(247,129,102,0.1);border:1px solid #f78166;
          color:#f78166;border-radius:6px;padding:7px 16px;
          font-size:0.82rem;font-weight:700;text-decoration:none;
          font-family:'Syne',system-ui,sans-serif;transition:all 0.15s;"
   onmouseover="this.style.background='rgba(247,129,102,0.2)'"
   onmouseout="this.style.background='rgba(247,129,102,0.1)'">
  ðŸ”¬ Algorithm Walkthrough
        </a>
      </div>
</header>
    <div class="banner" id="rt-banner">&#x23F3; Checking roundtrip status...</div>

    <div class="toolbar">
      <div class="section-title" style="margin-bottom:0">Compression Results</div>
      <button class="copy-btn" id="copy-btn">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
          <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
          <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
        </svg>
        Copy results.json
      </button>
    </div>

    <div class="legend">
      <div class="legend-item"><div class="dot" style="background:#f78166"></div>MBFA</div>
      <div class="legend-item"><div class="dot" style="background:#79c0ff"></div>gzip</div>
      <div class="legend-item"><div class="dot" style="background:#a371f7"></div>zstd</div>
      <div class="legend-item"><div class="dot" style="background:#e3b341"></div>xz</div>
      <div class="legend-item"><div class="dot" style="background:#3fb950"></div>brotli</div>
      <div class="legend-item"><div class="dot" style="background:#ff7b72"></div>zpaq</div>
    </div>
    <p class="click-hint">&#x1F4A1; Click any row for a detailed breakdown</p>

    <table>
      <thead>
        <tr>
          <th>Dataset</th>
          <th>Original</th>
          <th>MBFA</th>
          <th>gzip</th>
          <th>zstd</th>
          <th>xz</th>
          <th>brotli</th>
          <th>zpaq</th>
          <th>RT</th>
          <th>Visual</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="section-title">About MBFA &#x2014; Conceptual Status</div>
    <div class="notes">
      <p><strong style="color:#e6edf3">What MBFA is:</strong> MidMans Bit Folding Algorithm is a novel multi-fold iterative compression algorithm under active research and development by MidManStudio. The core concept â€” encoding data as an instruction chain where each fold produces a bitstream that reconstructs the previous fold â€” is architecturally distinct from existing published compression algorithms.</p>
      <br>
      <p><strong style="color:#e6edf3">Current implementation status:</strong> Research implementation with joint Huffman entropy coding on the fold output layer. All roundtrips pass. Active improvements ongoing.</p>
      <br>
      <p><strong style="color:#e6edf3">Where MBFA wins:</strong> Highly repetitive data â€” the multi-fold convergence dramatically outperforms gzip and zstd by exploiting structure that single-pass algorithms cannot see across their own metadata.</p>
      <br>
      <p><strong style="color:#e6edf3">Current prose performance:</strong> Joint Huffman on the fold output layer brought prose compression to within ~2â€“3% of gzip on large files. The remaining gap is the flat-cost BACKREF offset field (15 raw bits each) â€” a known target for further improvement.</p>
      <br>
      <p>Lower % = better compression. 100% = incompressible data correctly passed through with near-zero overhead.</p>
    </div>

    <footer>MidMans Bit Folding Algorithm (MBFA) &#x2014; MidManStudio &#x2014; Build #125</footer>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="modal-title">Dataset</div>
          <div class="modal-subtitle" id="modal-subtitle"></div>
        </div>
        <button class="modal-close" id="modal-close" aria-label="Close">&#x2715;</button>
      </div>
      <div class="modal-body">
        <div>
          <div class="modal-section-label">Summary</div>
          <div class="stat-grid" id="modal-stats"></div>
        </div>
        <div>
          <div class="modal-section-label">Compression Comparison</div>
          <div class="cmp-row" id="modal-cmp"></div>
        </div>
        <div>
          <div class="modal-section-label">Fold Pipeline</div>
          <div class="fold-steps" id="modal-folds"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let allData = [];

    // Dataset category detection
    function getCategory(name) {
      const n = name.toLowerCase();
      if (n.includes('json'))  return { label:'JSON',  cls:'badge-json'  };
      if (n.includes('audio') || n.includes('wav')) return { label:'Audio', cls:'badge-audio' };
      if (n.includes('image') || n.includes('bmp')) return { label:'Image', cls:'badge-image' };
      if (n.includes('random') || n.includes('bin')) return { label:'Binary', cls:'badge-bin' };
      return { label:'Text', cls:'badge-text' };
    }

    function fmtBytes(n) {
      return n >= 1048576 ? (n/1048576).toFixed(1)+' MB'
           : n >= 1024    ? (n/1024).toFixed(1)+' KB'
           : n + ' B';
    }

    function fmtPct(p) {
      const v = parseFloat(p);
      const color = v < 50 ? '#3fb950' : v < 80 ? '#e3b341' : v < 100 ? '#f85149' : '#8b949e';
      return { text: p+'%', color };
    }

    function parseFolds(detail) {
      return (detail || '').split('|').filter(Boolean).map(l => l.trim());
    }

    function vsClass(mbfa, other) {
      const m = parseFloat(mbfa), o = parseFloat(other);
      return m < o ? 'win' : m > o ? 'loss' : 'tie';
    }

    fetch('results.json')
      .then(r => r.json())
      .then(data => {
        allData = data;
        const tbody = document.getElementById('tbody');
        let allPass = true;
        tbody.innerHTML = '';

        data.forEach((row, idx) => {
          if (row.mbfa_roundtrip !== 'PASS') allPass = false;
          const cat  = getCategory(row.dataset);
          const cls  = vsClass(row.mbfa_pct, row.gzip_pct);
          const rtcls = row.mbfa_roundtrip === 'PASS' ? 'pass' : 'fail-rt';

          const scale = v => Math.min(140, Math.round(parseFloat(v) * 1.4));

          function cell(pct, bytes, ms, colorClass) {
            return `<td class="${colorClass}">${pct}%<br>
              <span class="sub">${ms}ms &bull; ${fmtBytes(bytes)}</span></td>`;
          }

          const tr = document.createElement('tr');
          tr.dataset.idx = idx;
          tr.innerHTML =
            `<td style="font-weight:600">${row.dataset.replace(/_/g,' ')}
               <span class="badge ${cat.cls}">${cat.label}</span></td>` +
            `<td>${fmtBytes(row.original_bytes)}</td>` +
            cell(row.mbfa_pct,   row.mbfa_bytes,   row.mbfa_ms,   cls) +
            cell(row.gzip_pct,   row.gzip_bytes,   row.gzip_ms,   '') +
            `<td style="color:#a371f7">${row.zstd_pct}%<br>
               <span class="sub">${row.zstd_ms}ms &bull; ${fmtBytes(row.zstd_bytes)}</span></td>` +
            `<td style="color:#e3b341">${row.xz_pct   !== undefined ? row.xz_pct+'%'   : 'â€”'}<br>
               <span class="sub">${row.xz_ms !== undefined ? row.xz_ms+'ms &bull; '+fmtBytes(row.xz_bytes) : ''}</span></td>` +
            `<td style="color:#3fb950">${row.brotli_pct !== undefined ? row.brotli_pct+'%' : 'â€”'}<br>
               <span class="sub">${row.brotli_ms !== undefined ? row.brotli_ms+'ms &bull; '+fmtBytes(row.brotli_bytes) : ''}</span></td>` +
            `<td style="color:#ff7b72">${row.zpaq_pct !== undefined ? row.zpaq_pct+'%' : 'â€”'}<br>
               <span class="sub">${row.zpaq_ms !== undefined ? row.zpaq_ms+'ms &bull; '+fmtBytes(row.zpaq_bytes) : ''}</span></td>` +
            `<td class="${rtcls}">${row.mbfa_roundtrip}</td>` +
            `<td>
              <div class="bar-row"><div class="bar bar-mbfa"  style="width:${scale(row.mbfa_pct)}px"></div><span style="font-size:0.72rem;color:#f78166">${row.mbfa_pct}%</span></div>
              <div class="bar-row"><div class="bar bar-gzip"  style="width:${scale(row.gzip_pct)}px"></div><span style="font-size:0.72rem;color:#79c0ff">${row.gzip_pct}%</span></div>
              <div class="bar-row"><div class="bar bar-zstd"  style="width:${scale(row.zstd_pct)}px"></div><span style="font-size:0.72rem;color:#a371f7">${row.zstd_pct}%</span></div>
              ${row.xz_pct   !== undefined ? `<div class="bar-row"><div class="bar bar-xz"   style="width:${scale(row.xz_pct)}px"></div><span style="font-size:0.72rem;color:#e3b341">${row.xz_pct}%</span></div>` : ''}
              ${row.brotli_pct !== undefined ? `<div class="bar-row"><div class="bar bar-br" style="width:${scale(row.brotli_pct)}px"></div><span style="font-size:0.72rem;color:#3fb950">${row.brotli_pct}%</span></div>` : ''}
              ${row.zpaq_pct !== undefined ? `<div class="bar-row"><div class="bar bar-zpaq" style="width:${scale(row.zpaq_pct)}px"></div><span style="font-size:0.72rem;color:#ff7b72">${row.zpaq_pct}%</span></div>` : ''}
            </td>`;

          tr.addEventListener('click', () => openModal(idx));
          tbody.appendChild(tr);
        });

        const banner = document.getElementById('rt-banner');
        if (allPass) {
          banner.textContent = 'âœ… All roundtrip tests passed â€” compress â†’ decompress = exact original bytes';
        } else {
          banner.className = 'banner fail';
          banner.textContent = 'âŒ One or more roundtrip tests FAILED â€” check fold detail column';
        }
      })
      .catch(e => {
        document.getElementById('tbody').innerHTML =
          `<tr><td colspan="10" style="color:#f85149;text-align:center;padding:20px">Failed to load results.json: ${e}</td></tr>`;
      });

    document.getElementById('copy-btn').addEventListener('click', function() {
      const btn = this;
      navigator.clipboard.writeText(JSON.stringify(allData, null, 2)).then(() => {
        btn.classList.add('copied');
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Copied!';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/></svg> Copy results.json';
        }, 2000);
      });
    });

    function openModal(idx) {
      const row = allData[idx];
      document.getElementById('modal-title').textContent = row.dataset.replace(/_/g,' ');
      document.getElementById('modal-subtitle').textContent =
        fmtBytes(row.original_bytes) + ' original  â€¢  roundtrip: ' + row.mbfa_roundtrip;

      const mbfaPct  = fmtPct(row.mbfa_pct);
      const saved    = row.original_bytes - row.mbfa_bytes;
      const savedPct = ((saved / row.original_bytes) * 100).toFixed(1);
      const lines    = parseFolds(row.fold_detail);
      const keptFolds = lines.filter(l => /^Fold \d/.test(l) && !l.includes('not worth')).length;
      const totalAttempted = lines.filter(l => /^Fold \d/.test(l)).length;

      document.getElementById('modal-stats').innerHTML =
        `<div class="stat-card"><div class="stat-label">MBFA Size</div>
           <div class="stat-value" style="color:${mbfaPct.color}">${mbfaPct.text}</div>
           <div class="stat-sub">${fmtBytes(row.mbfa_bytes)}</div></div>` +
        `<div class="stat-card"><div class="stat-label">Space Saved</div>
           <div class="stat-value" style="color:#3fb950">${saved > 0 ? savedPct+'%' : 'â€”'}</div>
           <div class="stat-sub">${saved > 0 ? fmtBytes(saved)+' freed' : 'no saving'}</div></div>` +
        `<div class="stat-card"><div class="stat-label">Encode Time</div>
           <div class="stat-value">${row.mbfa_ms}ms</div>
           <div class="stat-sub">release build</div></div>` +
        `<div class="stat-card"><div class="stat-label">Folds Used</div>
           <div class="stat-value" style="color:#79c0ff">${keptFolds}</div>
           <div class="stat-sub">${totalAttempted > keptFolds ? totalAttempted+' attempted' : 'all kept'}</div></div>` +
        `<div class="stat-card"><div class="stat-label">Roundtrip</div>
           <div class="stat-value" style="color:${row.mbfa_roundtrip==='PASS'?'#3fb950':'#f85149'}">${row.mbfa_roundtrip}</div>
           <div class="stat-sub">compress â†’ decompress</div></div>` +
        `<div class="stat-card"><div class="stat-label">vs gzip</div>
           <div class="stat-value" style="color:${parseFloat(row.mbfa_pct)<parseFloat(row.gzip_pct)?'#3fb950':'#f85149'}">
             ${parseFloat(row.mbfa_pct)<parseFloat(row.gzip_pct)?'âœ“ Wins':'âœ— Loses'}</div>
           <div class="stat-sub">gzip: ${row.gzip_pct}%</div></div>`;

      const allPcts = [row.mbfa_pct, row.gzip_pct, row.zstd_pct,
                       row.xz_pct, row.brotli_pct, row.zpaq_pct]
                      .filter(Boolean).map(parseFloat);
      const maxPct = Math.max(...allPcts, 10);

      function bar(pct, color) {
        if (pct === undefined || pct === null) return '';
        const w = Math.min(100,(parseFloat(pct)/maxPct)*100).toFixed(1);
        return `<div class="cmp-track"><div class="cmp-fill" style="width:${w}%;background:${color}"></div></div>`;
      }

      const algos = [
        { label:'MBFA',   pct:row.mbfa_pct,   bytes:row.mbfa_bytes,   ms:row.mbfa_ms,   color:'#f78166' },
        { label:'gzip',   pct:row.gzip_pct,   bytes:row.gzip_bytes,   ms:row.gzip_ms,   color:'#79c0ff' },
        { label:'zstd',   pct:row.zstd_pct,   bytes:row.zstd_bytes,   ms:row.zstd_ms,   color:'#a371f7' },
        { label:'xz',     pct:row.xz_pct,     bytes:row.xz_bytes,     ms:row.xz_ms,     color:'#e3b341' },
        { label:'brotli', pct:row.brotli_pct, bytes:row.brotli_bytes, ms:row.brotli_ms, color:'#3fb950' },
        { label:'zpaq',   pct:row.zpaq_pct,   bytes:row.zpaq_bytes,   ms:row.zpaq_ms,   color:'#ff7b72' },
      ];

      document.getElementById('modal-cmp').innerHTML = algos
        .filter(a => a.pct !== undefined && a.pct !== null)
        .map(a =>
          `<div class="cmp-item">
             <div class="cmp-label" style="color:${a.color}">${a.label}</div>
             ${bar(a.pct, a.color)}
             <div class="cmp-pct" style="color:${a.color}">${a.pct}%</div>
             <div class="cmp-bytes">${fmtBytes(a.bytes)} &bull; ${a.ms}ms</div>
           </div>`
        ).join('');

      let origBits = 0;
      let stepsHtml = '';
      lines.forEach(line => {
        if (line.startsWith('Original')) {
          const m = line.match(/([\d]+) bits/);
          if (m) origBits = parseInt(m[1]);
          stepsHtml += `<div class="fold-step">
            <div class="fold-step-icon origin">â†“</div>
            <div class="fold-step-content">
              <div class="fold-step-title">Original Data</div>
              <div class="fold-step-detail">${line.replace('Original size: ','')}</div>
            </div></div>`;
        } else if (/^Fold \d/.test(line) && !line.includes('not worth')) {
          const mN = line.match(/Fold (\d+) \((\w+)\)/);
          const mS = line.match(/([\d]+) bits \(([\d]+) bytes\)/);
          const fb  = mS ? parseInt(mS[1]) : 0;
          const ratio = origBits > 0 ? ((fb/origBits)*100).toFixed(1) : '0';
          const barW  = origBits > 0 ? Math.min(100,(fb/origBits)*100).toFixed(1) : 0;
          stepsHtml += `<div class="fold-step">
            <div class="fold-step-icon fold">F${mN?mN[1]:'?'}</div>
            <div class="fold-step-content">
              <div class="fold-step-title">Fold ${mN?mN[1]:'?'} â€” ${mN?mN[2]:''}</div>
              <div class="fold-step-detail">${mS?mS[1]+' bits ('+mS[2]+' bytes)':line}</div>
              <div class="fold-step-bar-track"><div class="fold-step-bar-fill" style="width:${barW}%"></div></div>
              <div class="fold-step-ratio">${ratio}% of original</div>
            </div></div>`;
        } else if (line.includes('Joint entropy') || line.includes('Entropy')) {
          stepsHtml += `<div class="fold-step">
            <div class="fold-step-icon entropy">H</div>
            <div class="fold-step-content">
              <div class="fold-step-title" style="color:#a371f7">Joint Huffman Entropy</div>
              <div class="fold-step-detail">${line}</div>
            </div></div>`;
        } else if (line.includes('not worth')) {
          stepsHtml += `<div class="fold-step">
            <div class="fold-step-icon stop">âœ—</div>
            <div class="fold-step-content">
              <div class="fold-step-title" style="color:#f85149">Fold rejected</div>
              <div class="fold-step-detail">${line}</div>
            </div></div>`;
        } else if (line.startsWith('Done')) {
          stepsHtml += `<div class="fold-step">
            <div class="fold-step-icon done">âœ“</div>
            <div class="fold-step-content">
              <div class="fold-step-title" style="color:#3fb950">Final output</div>
              <div class="fold-step-detail">${line}</div>
            </div></div>`;
        }
      });
      document.getElementById('modal-folds').innerHTML = stepsHtml;

      document.getElementById('modal-overlay').classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('open');
      document.body.style.overflow = '';
    }

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-overlay').addEventListener('click', e => {
      if (e.target === document.getElementById('modal-overlay')) closeModal();
    });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
  </script>
</body>
            </html>
